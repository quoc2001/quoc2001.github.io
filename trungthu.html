@@<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trung Thu</title>
    <style></style>
    <link rel="stylesheet" href="css/trungthu.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="stage">
        <canvas id="starfield"></canvas>

        <div class="moon" aria-hidden="true"></div>

        <div id="lantern-container"></div>

        <div id="wish-popup" role="dialog" aria-live="polite"></div>

        <div id="hint">Chạm màn hình để mở nhạc và thả đèn ✨</div>

        <div class="controls">
            <span class="music-toggle" id="musicToggle"></span>
        </div>

        <!-- Hộp thoại mời đi chơi -->
        <div id="invitation-modal">
            <div class="invitation-box">
                <div class="invitation-title">💫 Lời Mời Đặc Biệt 💫</div>
                <div class="invitation-message">
                    Trung thu rồi mà chưa rủ em đi chơi được<br>
                    Cuối tuần này đi chơi với anh không bé?✨
                </div>
                <div class="invitation-buttons">
                    <button class="invitation-btn btn-yes" id="btn-yes">Được nha! 💕</button>
                    <button class="invitation-btn btn-no" id="btn-no">Để em nghĩ...</button>
                </div>
            </div>
        </div>

    </div>

    <audio id="bg-music" loop>
        <!-- Thay file nhạc ở đây -->
        <source src="music/music.mp3" type="audio/mp3">
    </audio>

    <script>
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let w, h, stars = [], meteors = [];
        function resizeCanvas() {
            w = canvas.width = innerWidth;
            h = canvas.height = innerHeight;
            stars = [];
            const count = Math.round((w * h) / 2200);
            for (let i = 0; i < count; i++) {
                stars.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    r: Math.random() * 0.9 + 0.1,
                    a: Math.random() * 0.8 + 0.2,
                    t: Math.random() * 0.02 + 0.002
                });
            }
        }
        function drawStars() {
            ctx.clearRect(0, 0, w, h);
            for (const s of stars) {
                s.a += (Math.random() > 0.5 ? 1 : -1) * s.t;
                s.a = Math.max(0.05, Math.min(1, s.a));
                ctx.beginPath();
                ctx.globalAlpha = s.a;
                ctx.fillStyle = '#fff';
                ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
        }
        function createMeteor() {
            const startX = Math.random() * w;
            const startY = Math.random() * (h / 3);
            const speed = Math.random() * 10 + 6;
            meteors.push({
                x: startX, y: startY, vx: speed + 6, vy: speed / 2, len: Math.random() * 120 + 100, a: 1
            });
        }
        function drawMeteors() {
            for (let i = meteors.length - 1; i >= 0; i--) {
                const m = meteors[i];
                const x2 = m.x - m.len;
                const y2 = m.y - m.len / 2;
                const g = ctx.createLinearGradient(m.x, m.y, x2, y2);
                g.addColorStop(0, `rgba(255,255,255,${m.a})`);
                g.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.strokeStyle = g;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(m.x, m.y);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                m.x += m.vx; m.y += m.vy; m.a -= 0.02;
                if (m.a <= 0 || m.x > w + 200 || m.y > h + 200) meteors.splice(i, 1);
            }
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
        }
        function loop() {
            drawStars();
            drawMeteors();
            if (Math.random() < 0.01) createMeteor();
            requestAnimationFrame(loop);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        loop();

        const lanternContainer = document.getElementById('lantern-container');
        //Thay lời chúc ở đây
        const wishes = [
            "Chúc em Trung Thu thật vui vẻ, nhiều niềm vui và ánh trăng đẹp như nụ cười của em.",
            "Trung Thu này mong em sẽ có thật nhiều niềm vui, và nếu có thể thì hy vọng anh cũng được góp chút vào đó.",
            "Người ta hay đi ngắm trăng Trung Thu, còn anh thì chỉ muốn gửi lời chúc dễ thương cho em thôi.",
            "Chúc em Trung Thu ấm áp, ngọt ngào như bánh, lung linh như đèn lồng nhé!"
        ];

        let lanternClickable = true;

        function createLantern() {
            const lantern = document.createElement("img");
            //Thay ảnh đèn lồng ở đây
            lantern.src = "images/den.png";
            lantern.className = "lantern swing";

            const layer = Math.floor(Math.random() * 3) + 1;
            let size = 40, duration = 10000, opacity = 0.8;

            if (layer === 1) { size = 20 + Math.random() * 20; duration = 14000 + Math.random() * 5000; opacity = 0.5; }
            else if (layer === 2) { size = 30 + Math.random() * 30; duration = 12000 + Math.random() * 4000; opacity = 0.7; }
            else { size = 40 + Math.random() * 40; duration = 10000 + Math.random() * 3000; opacity = 0.95; }

            lantern.style.width = size + "px";
            lantern.style.left = Math.random() * 90 + "vw";
            lantern.style.bottom = "0px";
            lantern.style.opacity = opacity;

            lanternContainer.appendChild(lantern);

            const drift = Math.random() * 140 - 70;
            const up = 120 + Math.random() * 40;
            lantern.animate([
                { transform: "translate(0,0)", opacity: opacity },
                { transform: `translate(${drift}px, -${up}vh)`, opacity: 0 }
            ], { duration: duration, easing: "linear", fill: "forwards" });

            setTimeout(() => lantern.remove(), duration);

            lantern.addEventListener("click", (e) => {
                e.stopPropagation();
                const wishPopup = document.getElementById('wish-popup');
                wishPopup.textContent = wishes[Math.floor(Math.random() * wishes.length)];
                wishPopup.style.display = 'block';
            });

        }

        setInterval(createLantern, 500);

        const bg = document.getElementById('bg-music');
        const musicToggle = document.getElementById('musicToggle');
        let musicStarted = false;
        function startMusic() {
            if (musicStarted) return;
            if (!bg) return;
            bg.volume = 0.0;
            bg.play().then(() => {
                let v = 0;
                const i = setInterval(() => {
                    v += 0.05;
                    if (v >= 0.9) { v = 0.9; clearInterval(i); }
                    bg.volume = v;
                }, 120);
                musicStarted = true;
                musicToggle.textContent = '🔊';
                const hint = document.getElementById('hint');
                hint.style.opacity = '1';
                setTimeout(() => hint.style.opacity = '0', 3500);
            }).catch(() => { });
        }

        musicToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!musicStarted) { startMusic(); return; }
            if (bg.paused) { bg.play(); musicToggle.textContent = '🔊'; }
            else { bg.pause(); musicToggle.textContent = '🔈'; }
        });

        // document.addEventListener('pointerdown', function onceStart() {
        //     startMusic();
        //     document.removeEventListener('pointerdown', onceStart);
        // });
        // Phát nhạc khi có bất kỳ tương tác nào (click, touch)
        function tryStartMusic() {
            if (!musicStarted) {
                startMusic();
            }
        }

        document.addEventListener('click', tryStartMusic);
        document.addEventListener('touchstart', tryStartMusic);
        document.addEventListener('pointerdown', tryStartMusic);

        document.addEventListener('click', (e) => {
            const pop = document.getElementById('wish-popup');
            if (pop && pop.style.display === 'block') {
                pop.style.display = 'none';
            }
        });

        for (let i = 0; i < 4; i++) { setTimeout(createLantern, i * 600); }

        // Xử lý hộp thoại mời đi chơi
        const invitationModal = document.getElementById('invitation-modal');
        const btnYes = document.getElementById('btn-yes');
        const btnNo = document.getElementById('btn-no');

        // Hiển thị hộp thoại sau 3 giây
        setTimeout(() => {
            invitationModal.classList.add('show');
        }, 3000);

        // 

        // Thêm e.stopPropagation() và setTimeout
        btnYes.addEventListener('click', (e) => {
            e.stopPropagation();
            invitationModal.classList.remove('show');

            setTimeout(() => {
                const wishPopup = document.getElementById('wish-popup');
                wishPopup.textContent = "Yeyyy! Anh vui quá! 💕✨🎉";
                wishPopup.style.display = 'block';
                wishPopup.style.zIndex = '99999';

                setTimeout(() => {
                    wishPopup.style.display = 'none';
                }, 4000);
            }, 400);
        });

        btnNo.addEventListener('click', (e) => {
            e.stopPropagation();
            invitationModal.classList.remove('show');

            setTimeout(() => {
                const wishPopup = document.getElementById('wish-popup');
                wishPopup.textContent = "Không sao, anh sẽ đợi em... 🥺";
                wishPopup.style.display = 'block';
                wishPopup.style.zIndex = '99999';

                setTimeout(() => {
                    wishPopup.style.display = 'none';
                }, 3000);
            }, 400);
        });

    </script>
</body>


</html>
