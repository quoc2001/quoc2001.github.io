<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopee Affiliate Link Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #ee5a24;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #ee5a24;
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        .affiliate-id-display {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            border-left: 4px solid #ffc107;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .btn-convert {
            background: #ee5a24;
            color: white;
        }

        .btn-convert:hover {
            background: #c44621;
            transform: translateY(-2px);
        }

        .btn-convert:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-copy {
            background: #27ae60;
            color: white;
        }

        .btn-copy:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-clear {
            background: #95a5a6;
            color: white;
        }

        .btn-clear:hover {
            background: #7f8c8d;
        }

        .result-area {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            background: #e8f5e8;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .converted-link {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            word-break: break-all;
            font-size: 13px;
        }

        .link-original {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .link-generated {
            font-family: monospace;
            font-size: 12px;
            color: #2c3e50;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin-top: 8px;
            max-height: 120px;
            overflow-y: auto;
        }

        .clickable-link {
            display: inline-block;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white !important;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            margin: 10px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(238, 90, 36, 0.3);
            font-size: 14px;
            text-align: center;
            min-width: 200px;
        }

        .clickable-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 90, 36, 0.4);
            text-decoration: none;
            color: white !important;
        }

        .clickable-link:active {
            transform: translateY(0);
        }

        .btn-copy-single {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-copy-single:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .link-container {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
            border-left: 4px solid #dc3545;
        }

        .info-box {
            background: #cce5ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 14px;
        }

        .warning-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 14px;
            color: #0c5460;
        }

        .loading-box {
            text-align: center;
            padding: 20px;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ee5a24;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
            }

            .stats {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üõçÔ∏è Shopee Affiliate Link Generator</h1>
        <div class="subtitle">G·∫Øn Affiliate ID v√†o link s·∫£n ph·∫©m Shopee (h·ªó tr·ª£ link r√∫t g·ªçn)</div>

        <div class="warning-box">
            <strong>‚úÖ H·ªó tr·ª£ t·∫•t c·∫£ link Shopee:</strong><br>
            ‚Ä¢ shopee.vn/product/... ‚úÖ<br>
            ‚Ä¢ shopee.vn/t√™n-s·∫£n-ph·∫©m-i.... ‚úÖ<br>
            ‚Ä¢ s.shopee.vn/... ‚úÖ (t·ª± ƒë·ªông m·ªü r·ªông)<br>
            ‚Ä¢ vn.shp.ee/... ‚úÖ (t·ª± ƒë·ªông m·ªü r·ªông)<br>
            ‚Ä¢ C√°c link kh√°c (lazada, tiki, amazon...) ‚ùå KH√îNG h·ªó tr·ª£
        </div>

        <div class="info-box">
            <strong>üí° C√°ch s·ª≠ d·ª•ng:</strong><br>
            ‚Ä¢ Paste 1 link s·∫£n ph·∫©m Shopee (bao g·ªìm link r√∫t g·ªçn) v√†o √¥ b√™n d∆∞·ªõi<br>
            ‚Ä¢ Tool s·∫Ω t·ª± ƒë·ªông m·ªü r·ªông link r√∫t g·ªçn v√† t·∫°o affiliate link<br>
            ‚Ä¢ Click n√∫t "üõçÔ∏è M·ªü S·∫£n Ph·∫©m" ƒë·ªÉ test ho·∫∑c copy link ƒë·ªÉ chia s·∫ª<br>
            ‚Ä¢ H·ªó tr·ª£: shopee.vn, s.shopee.vn, vn.shp.ee
        </div>

        <div class="affiliate-id-display">
            üéØ Affiliate ID: <span id="affiliateId">17309510004</span>
        </div>

        <div class="input-group">
            <label for="inputLinks">üìã Nh·∫≠p link s·∫£n ph·∫©m Shopee (h·ªó tr·ª£ link r√∫t g·ªçn):</label>
            <textarea id="inputLinks" rows="3" placeholder="Paste 1 link s·∫£n ph·∫©m shopee v√†o ƒë√¢y:
https://shopee.vn/product/1264383914/26138270984
https://s.shopee.vn/9A8B7C6D
https://vn.shp.ee/XyZ123"></textarea>
        </div>

        <div class="button-group">
            <button id="btnConvert" class="btn-convert">üîÑ T·∫°o Affiliate Link</button>
            <button id="btnCopy" class="btn-copy">üìã Copy Link</button>
            <button id="btnClear" class="btn-clear">üóëÔ∏è X√≥a H·∫øt</button>
        </div>

        <div id="resultsSection" class="result-area" style="display: none;">
            <div class="stats">
                <span>T·ªïng link: <span id="totalLinks">0</span></span>
                <span>ƒê√£ t·∫°o: <span id="generatedCount">0</span></span>
                <span>L·ªói: <span id="errorCount">0</span></span>
            </div>

            <div id="generatedLinks"></div>
        </div>

        <div id="successMessage" class="success-message">
            ‚úÖ ƒê√£ copy affiliate link th√†nh c√¥ng!
        </div>

        <div id="errorMessage" class="error-message"></div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            AFFILIATE_ID: '17309510004',
            TIMEOUT: 15000,
            MAX_RETRIES: 3
        };

        // ===== GLOBAL STATE =====
        let currentState = {
            affiliateLink: '',
            isProcessing: false
        };

        // ===== UTILITY FUNCTIONS =====
        function generateRandomString(length = 8) {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
        }

        function generateTrackingParams() {
            return {
                'gads_t_sig': 'VTJGc2RHVmtYMTlxTFVSVVRrdENkZmdTUmpMeSszRElEdm91eXFrOVhzNS9BUFZoV3EvdzBSejdLalVDMURHQ1Z6TVI1b3NuSmxLR1IxalhlcDl5OWlnb00vdnZhSUdlRHlaeXRjQXJoTjdNUk94aGhYTVZUbUpZaGR0RVhCM29RUzJDc01rKytHOW41VDNPV3JtQmoyYWtSRjNQSkVDUkk3WnNmZW5lMjNFPQ',
                'uls_trackid': generateRandomString(12),
                'utm_campaign': `id_${generateRandomString(10)}`,
                'utm_content': '----',
                'utm_medium': 'affiliates',
                'utm_source': `an_${CONFIG.AFFILIATE_ID}`,
                'utm_term': generateRandomString(12)
            };
        }

        function normalizeUrl(url) {
            if (!url) return '';

            let normalized = url.trim();

            // Add https:// if missing protocol
            if (!normalized.match(/^https?:\/\//)) {
                normalized = 'https://' + normalized;
            }

            return normalized;
        }

        // ===== VALIDATION FUNCTIONS =====
        function isValidShopeeLink(url) {
            if (!url) return false;

            const normalizedUrl = normalizeUrl(url).toLowerCase();
            const validPatterns = [
                /^https:\/\/shopee\.vn\/.+/,
                /^https:\/\/s\.shopee\.vn\/.+/,
                /^https:\/\/vn\.shp\.ee\/.+/
            ];

            return validPatterns.some(pattern => pattern.test(normalizedUrl));
        }

        function isShortLink(url) {
            if (!url) return false;

            const normalizedUrl = normalizeUrl(url).toLowerCase();
            const shortLinkPatterns = [
                /^https:\/\/s\.shopee\.vn\/.+/,
                /^https:\/\/vn\.shp\.ee\/.+/
            ];

            return shortLinkPatterns.some(pattern => pattern.test(normalizedUrl));
        }

        // ===== PRODUCT INFO EXTRACTION =====
        function extractProductInfo(url) {
            if (!url || !url.includes('shopee.vn/')) {
                return null;
            }

            const cleanUrl = url.split('?')[0];

            // Pattern 1: https://shopee.vn/product/shopid/itemid
            const productPattern = /shopee\.vn\/product\/(\d+)\/(\d+)/;
            const productMatch = cleanUrl.match(productPattern);
            if (productMatch) {
                return {
                    shopId: productMatch[1],
                    itemId: productMatch[2],
                    baseUrl: cleanUrl,
                    type: 'product'
                };
            }

            // Pattern 2: https://shopee.vn/product-name-i.shopid.itemid
            const namedPattern = /shopee\.vn\/.*-i\.(\d+)\.(\d+)/;
            const namedMatch = cleanUrl.match(namedPattern);
            if (namedMatch) {
                return {
                    shopId: namedMatch[1],
                    itemId: namedMatch[2],
                    baseUrl: cleanUrl,
                    type: 'named_product'
                };
            }

            // Pattern 3: Any other shopee.vn link
            return {
                baseUrl: cleanUrl,
                type: 'general'
            };
        }

        // ===== AFFILIATE LINK CREATION =====
        function createAffiliateLink(productInfo) {
            if (!productInfo || !productInfo.baseUrl) {
                return null;
            }

            const trackingParams = new URLSearchParams(generateTrackingParams());
            return `${productInfo.baseUrl}?${trackingParams.toString()}`;
        }

        // ===== SHORT LINK EXPANSION =====
        async function expandShortLink(shortUrl) {
            const normalizedUrl = normalizeUrl(shortUrl);

            // Method 1: Try with fetch and follow redirects
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

                const response = await fetch(normalizedUrl, {
                    method: 'HEAD',
                    redirect: 'follow',
                    signal: controller.signal,
                    mode: 'no-cors'
                });

                clearTimeout(timeoutId);

                if (response.url && response.url !== normalizedUrl) {
                    return response.url;
                }
            } catch (error) {
                console.log('Method 1 failed:', error.message);
            }

            // Method 2: Use a simple proxy service
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(normalizedUrl)}`;
                const response = await fetch(proxyUrl);

                if (response.ok) {
                    const data = await response.json();
                    if (data.status && data.status.url && data.status.url !== normalizedUrl) {
                        return data.status.url;
                    }
                }
            } catch (error) {
                console.log('Method 2 failed:', error.message);
            }

            // Method 3: Manual expansion instruction
            throw new Error(`
        Kh√¥ng th·ªÉ t·ª± ƒë·ªông m·ªü r·ªông link r√∫t g·ªçn.<br><br>
        <strong>Vui l√≤ng l√†m theo c√°c b∆∞·ªõc sau:</strong><br>
        1. M·ªü link trong tab m·ªõi: <a href="${normalizedUrl}" target="_blank">${normalizedUrl}</a><br>
        2. Copy URL ƒë·∫ßy ƒë·ªß t·ª´ thanh ƒë·ªãa ch·ªâ browser<br>
        3. Paste URL ƒë·∫ßy ƒë·ªß v√†o tool n√†y<br><br>
        <em>Tool s·∫Ω ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng v·ªõi URL ƒë·∫ßy ƒë·ªß.</em>
    `);
        }

        // ===== UI FUNCTIONS =====
        function getElement(id) {
            return document.getElementById(id);
        }

        function showElement(id) {
            const element = getElement(id);
            if (element) element.style.display = 'block';
        }

        function hideElement(id) {
            const element = getElement(id);
            if (element) element.style.display = 'none';
        }

        function showError(message) {
            const errorElement = getElement('errorMessage');
            if (errorElement) {
                errorElement.innerHTML = `<strong>‚ùå L·ªói:</strong> ${message}`;
                showElement('errorMessage');

                setTimeout(() => hideElement('errorMessage'), 10000);
            }
        }

        function showSuccess() {
            showElement('successMessage');
            setTimeout(() => hideElement('successMessage'), 3000);
        }

        function showLoading() {
            const resultsSection = getElement('resultsSection');
            if (resultsSection) {
                resultsSection.innerHTML = `
            <div class="loading-box">
                <div class="spinner"></div>
                <div style="font-size: 16px; margin-bottom: 10px; font-weight: bold;">
                    üîÑ ƒêang x·ª≠ l√Ω link r√∫t g·ªçn...
                </div>
                <div style="font-size: 12px; color: #999;">
                    ƒêang m·ªü r·ªông link ƒë·ªÉ l·∫•y URL ƒë·∫ßy ƒë·ªß...<br>
                    Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t (c√≥ th·ªÉ m·∫•t 10-15 gi√¢y)
                </div>
            </div>
        `;
                showElement('resultsSection');
            }
        }

        function updateStats(total, success, error) {
            const elements = {
                totalLinks: getElement('totalLinks'),
                generatedCount: getElement('generatedCount'),
                errorCount: getElement('errorCount')
            };

            if (elements.totalLinks) elements.totalLinks.textContent = total;
            if (elements.generatedCount) elements.generatedCount.textContent = success;
            if (elements.errorCount) elements.errorCount.textContent = error;
        }

        // ===== DISPLAY RESULTS =====
        function displayResult(result) {
            hideElement('errorMessage');

            const resultsSection = getElement('resultsSection');
            const generatedLinks = getElement('generatedLinks');

            if (!resultsSection || !generatedLinks) return;

            // Update stats
            updateStats(1, result.status === 'success' ? 1 : 0, result.status === 'success' ? 0 : 1);

            // Store current affiliate link
            if (result.status === 'success') {
                currentState.affiliateLink = result.affiliateLink;
            }

            // Clear previous results
            generatedLinks.innerHTML = '';

            const linkDiv = document.createElement('div');
            linkDiv.className = 'converted-link';
            linkDiv.style.borderLeft = result.status === 'success' ? '4px solid #27ae60' : '4px solid #e74c3c';
            linkDiv.style.textAlign = 'center';

            if (result.status === 'success') {
                linkDiv.innerHTML = `
            <div style="font-weight: bold; color: #27ae60; margin-bottom: 15px; font-size: 16px;">
                ‚úÖ Affiliate Link ƒê√£ S·∫µn S√†ng!
            </div>
            
            <div class="link-original" style="text-align: left;">
                <strong>Link g·ªëc:</strong><br>${result.original}
                ${result.expanded ? `<br><br><strong>üîó Link ƒë√£ m·ªü r·ªông:</strong><br>${result.expanded}` : ''}
            </div>
            
            <div class="link-container">
                <div style="margin-bottom: 15px; color: #333; font-size: 16px; font-weight: bold;">
                    üöÄ Click ƒë·ªÉ test ngay ho·∫∑c copy ƒë·ªÉ chia s·∫ª:
                </div>
                <a href="${result.affiliateLink}" target="_blank" class="clickable-link" 
                   style="font-size: 16px; padding: 15px 30px; margin: 10px;">
                    üõçÔ∏è M·ªü S·∫£n Ph·∫©m Shopee
                </a>
                <br>
                <button class="btn-copy-single" onclick="copySingleLink()" 
                        style="font-size: 14px; padding: 12px 25px; margin-top: 10px;">
                    üìã Copy Affiliate Link
                </button>
                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                    Link s·∫Ω m·ªü trong tab m·ªõi v·ªõi tracking ƒë·∫ßy ƒë·ªß
                </div>
            </div>
            
            <details style="margin-top: 20px; text-align: left;">
                <summary style="cursor: pointer; color: #666; font-size: 12px; margin-bottom: 10px;">
                    üìã Xem link ƒë·∫ßy ƒë·ªß v√† tracking info
                </summary>
                <div class="link-generated">
                    <strong>üîó Affiliate Link ƒë·∫ßy ƒë·ªß:</strong><br>
                    <div style="word-break: break-all; margin-top: 5px; font-size: 11px;">
                        ${result.affiliateLink}
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: #666;">
                    <strong>üìä Tracking Info:</strong><br>
                    ‚Ä¢ Affiliate ID: <span style="color: #e74c3c; font-weight: bold;">${CONFIG.AFFILIATE_ID}</span><br>
                    ‚Ä¢ Type: ${result.productInfo ? result.productInfo.type : 'unknown'}<br>
                    ‚Ä¢ UTM Source: an_${CONFIG.AFFILIATE_ID}
                    ${result.expanded ? '<br>‚Ä¢ Expanded: ‚úÖ' : ''}
                </div>
            </details>
        `;
            } else {
                linkDiv.innerHTML = `
            <div style="color: #e74c3c; font-weight: bold; margin-top: 15px; font-size: 16px;">
                ‚ùå Kh√¥ng th·ªÉ t·∫°o link
            </div>
            <div class="link-original" style="text-align: left;">
                <strong>Link g·ªëc:</strong><br>${result.original}
            </div>
            <div style="color: #e74c3c; font-weight: bold; margin-top: 15px; font-size: 14px;">
                ${result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}
            </div>
        `;
            }

            generatedLinks.appendChild(linkDiv);
            showElement('resultsSection');
        }

        // ===== CLIPBOARD FUNCTIONS =====
        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    return true;
                } else {
                    return fallbackCopyTextToClipboard(text);
                }
            } catch (error) {
                console.error('Copy failed:', error);
                return fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                return successful;
            } catch (err) {
                document.body.removeChild(textArea);
                console.error('Fallback copy failed:', err);
                return false;
            }
        }

        // ===== MAIN FUNCTIONS =====
        async function generateAffiliateLinks() {
            // Prevent multiple simultaneous processes
            if (currentState.isProcessing) {
                showError('ƒêang x·ª≠ l√Ω, vui l√≤ng ƒë·ª£i...');
                return;
            }

            hideElement('errorMessage');
            hideElement('successMessage');

            const inputElement = getElement('inputLinks');
            if (!inputElement) return;

            const input = inputElement.value.trim();

            if (!input) {
                showError('Vui l√≤ng nh·∫≠p link s·∫£n ph·∫©m Shopee!');
                return;
            }

            // Process only first line
            const links = input.split('\n').filter(link => link.trim());
            const firstLink = links[0].trim();

            if (links.length > 1) {
                showError(`Tool ch·ªâ x·ª≠ l√Ω 1 link t·∫°i m·ªôt th·ªùi ƒëi·ªÉm.<br>ƒê√£ ph√°t hi·ªán ${links.length} links, ch·ªâ x·ª≠ l√Ω link ƒë·∫ßu ti√™n:<br><strong>"${firstLink.length > 60 ? firstLink.substring(0, 60) + '...' : firstLink}"</strong>`);
            }

            if (!isValidShopeeLink(firstLink)) {
                showError(`
            Link n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£!<br><br>
            <strong>‚úÖ Ch·ªâ h·ªó tr·ª£:</strong><br>
            ‚Ä¢ shopee.vn/product/...<br>
            ‚Ä¢ shopee.vn/t√™n-s·∫£n-ph·∫©m-i...<br>
            ‚Ä¢ s.shopee.vn/... (link r√∫t g·ªçn)<br>
            ‚Ä¢ vn.shp.ee/... (link r√∫t g·ªçn)<br><br>
            <strong>‚ùå Kh√¥ng h·ªó tr·ª£:</strong> lazada, tiki, amazon, facebook, v.v.<br><br>
            <strong>Link b·∫°n nh·∫≠p:</strong><br>${firstLink.length > 100 ? firstLink.substring(0, 100) + '...' : firstLink}
        `);
                return;
            }

            currentState.isProcessing = true;

            try {
                let processedLink = firstLink;
                let expandedLink = null;

                // Handle short links
                if (isShortLink(firstLink)) {
                    showLoading();

                    try {
                        processedLink = await expandShortLink(firstLink);
                        expandedLink = processedLink;

                        // Validate expanded link
                        if (!processedLink.includes('shopee.vn/')) {
                            throw new Error('Link m·ªü r·ªông kh√¥ng ph·∫£i t·ª´ shopee.vn');
                        }
                    } catch (error) {
                        currentState.isProcessing = false;
                        hideElement('resultsSection');
                        showError(error.message);
                        return;
                    }
                }

                // Extract product info and create affiliate link
                const productInfo = extractProductInfo(processedLink);
                const affiliateLink = createAffiliateLink(productInfo);

                const result = {
                    original: firstLink,
                    expanded: expandedLink,
                    affiliateLink: affiliateLink,
                    productInfo: productInfo,
                    status: affiliateLink ? 'success' : 'error',
                    error: affiliateLink ? null : 'Kh√¥ng th·ªÉ t·∫°o affiliate link cho URL n√†y'
                };

                displayResult(result);

            } catch (error) {
                console.error('Process error:', error);
                showError(`L·ªói x·ª≠ l√Ω: ${error.message}`);
                hideElement('resultsSection');
            } finally {
                currentState.isProcessing = false;
            }
        }

        async function copySingleLink() {
            if (!currentState.affiliateLink) {
                showError('Ch∆∞a c√≥ affiliate link n√†o ƒë·ªÉ copy!');
                return;
            }

            const success = await copyToClipboard(currentState.affiliateLink);

            if (success) {
                showSuccess();

                // Visual feedback on button
                const button = event.target;
                if (button) {
                    const originalText = button.innerHTML;
                    const originalBg = button.style.backgroundColor;

                    button.innerHTML = '‚úÖ ƒê√£ copy!';
                    button.style.backgroundColor = '#28a745';

                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.backgroundColor = originalBg;
                    }, 2000);
                }
            } else {
                showError('Kh√¥ng th·ªÉ copy link. Vui l√≤ng copy th·ªß c√¥ng.');
            }
        }

        function copyAllResults() {
            copySingleLink();
        }

        function clearAll() {
            const inputElement = getElement('inputLinks');
            if (inputElement) inputElement.value = '';

            hideElement('resultsSection');
            hideElement('successMessage');
            hideElement('errorMessage');

            currentState.affiliateLink = '';
            currentState.isProcessing = false;
        }

        // ===== EVENT LISTENERS =====
        function initializeEventListeners() {
            // Auto focus on input
            const inputElement = getElement('inputLinks');
            if (inputElement) {
                inputElement.focus();

                // Keyboard shortcuts
                inputElement.addEventListener('keydown', function (e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        generateAffiliateLinks();
                    }
                });

                // Hide error when user starts typing
                inputElement.addEventListener('input', function () {
                    hideElement('errorMessage');
                });
            }

            // Button event listeners
            const btnConvert = getElement('btnConvert');
            const btnCopy = getElement('btnCopy');
            const btnClear = getElement('btnClear');

            if (btnConvert) btnConvert.addEventListener('click', generateAffiliateLinks);
            if (btnCopy) btnCopy.addEventListener('click', copyAllResults);
            if (btnClear) btnClear.addEventListener('click', clearAll);
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Shopee Affiliate Link Generator initialized');
            initializeEventListeners();
        });

        // ===== GLOBAL EXPORTS =====
        window.generateAffiliateLinks = generateAffiliateLinks;
        window.copyAllResults = copyAllResults;
        window.copySingleLink = copySingleLink;
        window.clearAll = clearAll;
    </script>